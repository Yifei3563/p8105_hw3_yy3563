---
title: "p8105_hw3_yy3563"
author: "Yifei Yu"
date: "2024-10-12"
output: github_document
---

```{r}
library(dplyr)
library(tidyverse) 
library(patchwork)
library(haven)
library(ggplot2)
library(readxl)
```


## Problem 1

```{r}
library(p8105.datasets)
data("ny_noaa")
```

```{r}
head(ny_noaa)
dim(ny_noaa)
str(ny_noaa)
summary(ny_noaa)
```

The `ny_noaa` dataset includes variables such as `id`, `date`, `prcp`, `snow`, `snwd`, `tmax`, and `tmin`. There are 2595176 observations in the dataset. There are `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns. `id`, `tmax`, and `tmin` are characters. `prcp`, `snow`, and `snwd` are integers.

```{r}
sapply(ny_noaa, function(x) sum(is.na(x)))
sum(is.na(ny_noaa))
```

We can see that `id` and `date` have no missing value, while `prcp` has 145838 missing value, `snow` has 381221, `snwd` has 591786, `tmax` has 1134358, and `tmin` has 1134420 missing value. The overall number of missing value is 3387623.
Both `tmax` and `tmin` have a lot of missing value, which may lead to issues when analyzing data.

#### Clean the data

```{r}
ny_noaa_clean = ny_noaa |> 
  mutate(
    year = year(date),
    month = month(date),
    day = day(date)
  ) |> 
  mutate(
    tmax = as.numeric(as.character(tmax)),
    tmin = as.numeric(as.character(tmin))
  ) |> 
  mutate(
    tmax = tmax / 10,
    tmin = tmin / 10
  ) |> 
  mutate(
    prcp = prcp / 10,
    snow = snow /10,
    snwd = snwd /10
  )
```

#### Find the most commonly observed values for snowfall.

```{r}
common_snowfall = ny_noaa_clean |> 
  group_by(snow) |> 
  summarize(count = n()) |> 
  arrange(desc(count))

head(common_snowfall)
```

The most commonly observed values for snowfall is 0. This because snowfall occurs only during winter and only happen in certain regions. This would result in a high frequency of zero values in the dataset.

#### Create the Two-Panel Plot

```{r}
ny_noaa_clean |> 
  filter(month %in% c(1, 7)) |> 
  group_by(id, year, month) |> 
  summarize(mean_tmax = mean(tmax, na.rm = TRUE)) |> 
  ggplot(aes(x = year, y = mean_tmax, color = id)) +
  geom_point(show.legend = F) +
  facet_grid(. ~ month)
```

The average tmax in January show a much larger spread compared to July. Both of the months show a consistent pattern. There are a few outliers below -10Â°C in January. These could be caused by extremely cold days. There is one outlier in July where the station was recorded below 15. 

#### tmax vs tmin

```{r}
ny_noaa_clean |> 
  ggplot(aes(x = tmin, y = tmax)) +
  geom_hex() 
```


#### Plot showing the distribution of snowfall values greater than 0 and less than 100 separately by year

```{r}
ny_noaa_clean |> 
  filter(snow > 0 & snow < 100) |> 
  mutate(year = factor(year)) |> 
  ggplot(aes(x = year, y = snow)) +
  geom_boxplot()
```



## Problem 2

Import the two datasets.

```{r}
demographic = 
  read_csv("data/nhanes_covar.csv", skip = 4) |> 
  janitor::clean_names()
```

```{r}
accel = read_csv("data/nhanes_accel.csv") |> 
  janitor::clean_names()
```

Merge two datasets.

```{r}
final_df = left_join(demographic, accel, by = "seqn")
```

organize the data

```{r}
final_df = final_df |> 
  filter(age >= 21) |> 
  drop_na(sex, age, bmi, education) |> 
  mutate(
    sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
    education = factor(education, 
                       levels = c(1, 2, 3), 
                       labels = c("less than high school", "high school equivalent", "more than high school")),
    education = fct_relevel(education, "less than high school", "high school equivalent", "more than high school")
  )  
```

men and women

```{r}
final_df |> 
  group_by(sex, education) |> 
  summarize(n_obs = n()) |> 
  knitr::kable()

final_df |> 
  ggplot(aes(x = age, fill = sex)) +
  geom_density(alpha = 0.3) + 
  facet_grid(. ~ education) +
  labs(
    title = "Age Distributions for Men and Women by Education Category",
    x = "age",
    y = "density",
    fill = "sex"
  ) +
   theme_minimal()
```

create total activity variable

```{r}
final_df$total_activity <- rowSums(final_df %>% select(starts_with("min")), na.rm = TRUE)
```

plot total activity
```{r}
final_df |> 
  ggplot(aes(x = age, y = total_activity, color = sex)) +
  geom_point() +
  geom_smooth() +
  facet_grid(. ~ education) +
  labs(
    title = "Total Activity vs Age, Comparing Men and Women across Education Levels",
    x = "age",
    y = "total activity",
    color = "sex"
  ) 
```

Total activity tends to decrease with age across all education levels. Higher education levels are associated with less steep declines in activity with age. Women generally have higher total activity levels compared to men in younger and middle-age. 


three-panel plot

```{r}
final_df |> 
  pivot_longer(
    cols = min1:min1440,
    names_to = "time",
    values_to = "activity"
  ) |> 
  mutate(time=parse_number(time)) |> 
  ggplot(aes(x = time, y = activity)) +
  geom_point(aes(color = sex)) +
  geom_smooth() +
  facet_grid(. ~ education)
```



## Problem 3

import data

```{r}
Jan2020 = 
  read_csv("data/citibike/Jan 2020 Citi.csv") |> 
  janitor::clean_names()

Jan2024 = 
  read_csv("data/citibike/Jan 2024 Citi.csv") |> 
  janitor::clean_names()

July2020 = 
  read_csv("data/citibike/July 2020 Citi.csv") |> 
  janitor::clean_names()

July2024 = 
  read_csv("data/citibike/July 2024 Citi.csv") |> 
  janitor::clean_names()
```

```{r}
Jan2020$Year <- 2020
Jan2020$Month <- "Jan"
Jan2024$Year <- 2024
Jan2024$Month <- "Jan"

July2020$Year <- 2020
July2020$Month <- "July"
July2024$Year <- 2024
July2024$Month <- "July"

citi_bike <- bind_rows(Jan2020, Jan2024, July2020, July2024)
```

#### table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members

```{r}
citi_bike |> 
  group_by(member_casual, Year, Month) |> 
  summarize(rides = n()) |> 
  knitr::kable()
```

Based on the table generated above, both casual riders and members have shown significant growth in the number of rides from 2020 to 2024. Both casual riders and members show higher activity in July compared to January for both years, season plays a significant role.


#### table showing the 5 most popular starting stations for July 2024

```{r}
July2024 |> 
  group_by(start_station_name) |> 
  summarize(rides = n()) |> 
  arrange(desc(rides)) |> 
  head(5) |> 
  knitr::kable(
    caption="Top 5 most popular starting stations for July 2024",
    col.names = c("Start Station Name", "Number of rides")
  )
```


#### plot to investigate the effects of day of the week, month, and year on median ride duration

```{r}
citi_bike |> 
  mutate(
    Year = factor(Year),
    Month = factor(Month)
  ) |> 
  ggplot(aes(x = Month, y = duration, fill = weekdays)) +
  geom_boxplot() +
  facet_grid(. ~ Year)
```

July in both 2020 and 2024 has much more variability compared to Jun, showing that the warm summer have a greater variety of ride durations. Weekdays show a relatively consistent median ride duration across both years and months.


#### figure shows the impact of month, membership status, and bike type on the distribution of ride duration in 2024

```{r}
citi_bike |> 
  filter(Year == "2024") |> 
  mutate(
    Year = factor(Year),
    Month = factor(Month)
  ) |> 
  ggplot(aes(x = member_casual, y = duration, fill = rideable_type)) +
  geom_boxplot() +
  facet_grid(. ~ Month)
```

Classic bikes generally have a wider distribution of ride durations compared to electric bikes. Casual riders show more variability in their ride durations.
